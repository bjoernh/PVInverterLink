{% extends "base.jinja2" %}
{% block title %}Wechselrichter Verwaltung{% endblock %}
{% block content %}
    <div class="mx-auto w-full px-4 max-w-7xl">
        <div class="sm:mx-auto sm:w-full">
            <h2 class="mt-10 text-3xl font-bold leading-9 tracking-tight">Wechselrichter Verwaltung</h2>
        </div>

        <!-- Verification Warning -->
        {% if not user.is_verified %}
        <div class="alert alert-warning shadow-lg mt-6">
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <div>
                    <h3 class="font-bold">Email-Verifizierung ausstehend</h3>
                    <div class="text-xs">Bitte bestätigen Sie Ihre E-Mail-Adresse ({{ user.email }}), um Wechselrichter hinzuzufügen oder zu bearbeiten.</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Add New Inverter Section -->
        <div class="card bg-base-100 shadow-xl mt-6" hx-ext="response-targets">
            <div class="card-body">
                <h3 class="card-title">Neuen Wechselrichter hinzufügen</h3>
                <form id="add-form" class="flex flex-col gap-4"
                      hx-post="/inverter"
                      hx-ext='json-enc'
                      hx-target="#inverters-tbody"
                      hx-swap="beforeend"
                      hx-target-422="#add-error"
                      hx-target-403="#add-error"
                      hx-target-500="#add-error"
                      hx-target-503="#add-error"
                      hx-on::after-request="if(event.detail.successful) { document.getElementById('empty-state')?.remove(); document.getElementById('add-form').reset(); }">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="form-control flex-1">
                            <input name="name" type="text" placeholder="Name" class="input input-bordered w-full" {% if not user.is_verified %}disabled{% endif %} required />
                        </div>
                        <div class="form-control flex-1">
                            <input name="serial" type="text" placeholder="Seriennummer" class="input input-bordered w-full" {% if not user.is_verified %}disabled{% endif %} required />
                        </div>
                        <div class="form-control">
                            <button type="submit" class="btn btn-primary" {% if not user.is_verified %}disabled{% endif %}>Hinzufügen</button>
                        </div>
                    </div>
                    <div id="add-error" class="text-error"></div>
                </form>
            </div>
        </div>

        <!-- Inverters List -->
        <div class="mt-6">
            <h3 class="text-2xl font-bold mb-4">Meine Wechselrichter</h3>

            <div id="inverters-list" class="overflow-x-auto">
                <table class="table table-zebra w-full text-xs md:text-sm lg:text-base">
                    <thead>
                        <tr>
                            <th class="text-xs md:text-sm">Name</th>
                            <th class="text-xs md:text-sm">Seriennummer</th>
                            <th class="hidden lg:table-cell text-xs md:text-sm">Software Version</th>
                            <th class="text-right text-xs md:text-sm">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="inverters-tbody">
                        {% if inverters %}
                        {% for inverter in inverters %}
                        <tr id="inverter-row-{{ inverter.id }}">
                            <td class="text-xs md:text-sm py-2 md:py-3">
                                <span id="name-display-{{ inverter.id }}">{{ inverter.name }}</span>
                                <input id="name-edit-{{ inverter.id }}" type="text" value="{{ inverter.name }}" class="input input-bordered input-xs md:input-sm w-full hidden" />
                            </td>
                            <td class="text-xs md:text-sm py-2 md:py-3">
                                <span id="serial-display-{{ inverter.id }}">{{ inverter.serial_logger }}</span>
                                <input id="serial-edit-{{ inverter.id }}" type="text" value="{{ inverter.serial_logger }}" class="input input-bordered input-xs md:input-sm w-full hidden" />
                            </td>
                            <td class="hidden lg:table-cell text-xs md:text-sm">{{ inverter.sw_version }}</td>
                            <td class="text-right py-2 md:py-3">
                                <div class="flex flex-col gap-0.5 md:gap-1 lg:gap-2 justify-end">
                                    <!-- View Dashboard Button -->
                                    <a href="/dashboard/{{ inverter.id }}" class="btn btn-xs md:btn-sm btn-primary" title="Dashboard">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 md:h-4 w-3 md:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                        </svg>
                                    </a>

                                    <!-- Edit Button -->
                                    <button id="edit-btn-{{ inverter.id }}" class="btn btn-xs md:btn-sm btn-info" onclick="editInverter({{ inverter.id }})" {% if not user.is_verified %}disabled{% endif %} title="Bearbeiten">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 md:h-4 w-3 md:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>

                                    <!-- Save Button (hidden by default) -->
                                    <button id="save-btn-{{ inverter.id }}" class="btn btn-xs md:btn-sm btn-success hidden"
                                            hx-put="/inverter/{{ inverter.id }}"
                                            hx-ext="json-enc"
                                            hx-vals='js:{name: document.getElementById("name-edit-{{ inverter.id }}").value, serial: document.getElementById("serial-edit-{{ inverter.id }}").value}'
                                            hx-target="#inverter-row-{{ inverter.id }}"
                                            hx-swap="outerHTML"
                                            title="Speichern">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 md:h-4 w-3 md:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                    </button>

                                    <!-- Cancel Button (hidden by default) -->
                                    <button id="cancel-btn-{{ inverter.id }}" class="btn btn-xs md:btn-sm btn-ghost hidden" onclick="cancelEdit({{ inverter.id }})" title="Abbrechen">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 md:h-4 w-3 md:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>

                                    <!-- Delete Button -->
                                    <button id="delete-btn-{{ inverter.id }}" class="btn btn-xs md:btn-sm btn-error"
                                            hx-delete="/inverter/{{ inverter.id }}"
                                            hx-swap="delete"
                                            hx-target="#inverter-row-{{ inverter.id }}"
                                            hx-confirm="Soll der Wechselrichter '{{ inverter.name }}' wirklich gelöscht werden? Alle gespeicherten Daten werden gelöscht!"
                                            {% if not user.is_verified %}disabled{% endif %}
                                            title="Löschen">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 md:h-4 w-3 md:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr id="empty-state">
                            <td colspan="4" class="text-center text-base-content/60 py-8">
                                Noch keine Wechselrichter vorhanden. Fügen Sie Ihren ersten Wechselrichter oben hinzu.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- JavaScript for inline editing -->
    <script>
        function editInverter(id) {
            // Hide display elements and show edit inputs
            document.getElementById('name-display-' + id).classList.add('hidden');
            document.getElementById('serial-display-' + id).classList.add('hidden');
            document.getElementById('name-edit-' + id).classList.remove('hidden');
            document.getElementById('serial-edit-' + id).classList.remove('hidden');

            // Hide edit/delete buttons and show save/cancel buttons
            document.getElementById('edit-btn-' + id).classList.add('hidden');
            document.getElementById('delete-btn-' + id).classList.add('hidden');
            document.getElementById('save-btn-' + id).classList.remove('hidden');
            document.getElementById('cancel-btn-' + id).classList.remove('hidden');
        }

        function cancelEdit(id) {
            // Show display elements and hide edit inputs
            document.getElementById('name-display-' + id).classList.remove('hidden');
            document.getElementById('serial-display-' + id).classList.remove('hidden');
            document.getElementById('name-edit-' + id).classList.add('hidden');
            document.getElementById('serial-edit-' + id).classList.add('hidden');

            // Show edit/delete buttons and hide save/cancel buttons
            document.getElementById('edit-btn-' + id).classList.remove('hidden');
            document.getElementById('delete-btn-' + id).classList.remove('hidden');
            document.getElementById('save-btn-' + id).classList.add('hidden');
            document.getElementById('cancel-btn-' + id).classList.add('hidden');

            // Reset input values to original
            document.getElementById('name-edit-' + id).value = document.getElementById('name-display-' + id).textContent;
            document.getElementById('serial-edit-' + id).value = document.getElementById('serial-display-' + id).textContent;
        }
    </script>
{% endblock %}
