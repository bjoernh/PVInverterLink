{% extends "base.jinja2" %}
{% block title %}{{ inverter.name }} - Dashboard{% endblock %}
{% block content %}

<div class="mx-auto w-full px-2 md:px-4 py-4 md:py-6 max-w-7xl">
    <!-- Header with inverter info -->
    <div class="mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold">{{ inverter.name }}</h1>
                <p class="text-sm text-gray-500">Seriennummer: {{ inverter.serial_logger }}</p>
            </div>
            <div class="flex gap-2 flex-wrap">
                <a href="/dc-channels/{{ inverter.id }}" class="btn btn-secondary" hx-push-url="true">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Modul Details
                </a>
                <a href="/export/{{ inverter.id }}" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Exportieren
                </a>
                <a href="/" class="btn btn-ghost">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Zurück
                </a>
            </div>
        </div>
    </div>

    <!-- Today's Metrics Section Header -->
    <div class="mb-4">
        <h2 class="text-lg font-semibold text-gray-700">Heutige Metriken</h2>
        <p class="text-sm text-gray-500">Aktuelle Messwerte von heute</p>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="card bg-base-100 shadow-md">
            <div class="card-body p-4">
                <h3 class="text-sm font-medium text-gray-500">Aktuell</h3>
                <p id="stat-current" class="text-2xl font-bold">-- W</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-md">
            <div class="card-body p-4">
                <h3 class="text-sm font-medium text-gray-500">Maximum heute</h3>
                <p id="stat-max" class="text-2xl font-bold">-- W</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-md">
            <div class="card-body p-4">
                <h3 class="text-sm font-medium text-gray-500">Produktion Heute</h3>
                <p id="stat-today-kwh" class="text-2xl font-bold">-- kWh</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-md">
            <div class="card-body p-4">
                <h3 class="text-sm font-medium text-gray-500">Durchschnitt (letzte Stunde)</h3>
                <p id="stat-avg-hour" class="text-2xl font-bold">-- W</p>
            </div>
        </div>
    </div>

    <!-- Historic Data Section Header -->
    <div class="mb-4 mt-8">
        <h2 class="text-lg font-semibold text-gray-700">Detaillierter Verlauf</h2>
        <p class="text-sm text-gray-500">Historische Daten über den gewählten Zeitraum</p>
    </div>

    <!-- Time Range Selector -->
    <div class="card bg-base-100 shadow-md mb-6">
        <div class="card-body p-2 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="card-title">Leistungsverlauf</h2>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-500">Letztes Update: <span id="last-update">--</span></span>
                    <button id="refresh-btn" class="btn btn-circle btn-sm btn-ghost" onclick="loadDashboardData()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Time Range Buttons -->
            <div class="btn-group mb-4 flex-wrap">
                {% for range in valid_ranges %}
                <button class="btn btn-sm time-range-btn {% if range == time_range %}btn-active{% endif %}"
                        data-range="{{ range }}"
                        onclick="changeTimeRange('{{ range }}')">
                    {{ range_labels[range] }}
                </button>
                {% endfor %}
            </div>

            <!-- Chart Container - Responsive height -->
            <div id="powerChart" class="relative w-full" style="height: 350px;" data-mobile-height="350px" data-desktop-height="500px"></div>

            <!-- Loading/Error States -->
            <div id="loading-state" class="text-center py-8 hidden">
                <span class="loading loading-spinner loading-lg"></span>
                <p class="mt-2 text-gray-500">Daten werden geladen...</p>
            </div>
            <div id="error-state" class="alert alert-warning hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span id="error-message">Keine Daten verfügbar</span>
            </div>
        </div>
    </div>

    <!-- Energy Production Section Header -->
    <div class="mb-4 mt-8">
        <h2 class="text-lg font-semibold text-gray-700">Energieproduktion</h2>
        <p class="text-sm text-gray-500">Stündliche und tägliche Energieerzeugung</p>
    </div>

    <!-- Energy Production Chart Card -->
    <div class="card bg-base-100 shadow-md mb-6">
        <div class="card-body p-2 md:p-6">
            <h2 class="card-title mb-4">Energieproduktion</h2>

            <!-- Period Selector Buttons -->
            <div class="btn-group mb-4 flex-wrap">
                <button class="btn btn-sm energy-period-tab btn-active" data-period="day" onclick="changeEnergyPeriod('day')">
                    Tag
                </button>
                <button class="btn btn-sm energy-period-tab" data-period="week" onclick="changeEnergyPeriod('week')">
                    Woche
                </button>
                <button class="btn btn-sm energy-period-tab" data-period="month" onclick="changeEnergyPeriod('month')">
                    Monat
                </button>
            </div>

            <!-- Description Text -->
            <p id="energy-period-description" class="text-sm text-gray-500 mb-4">
                Stündliche Energieproduktion für heute
            </p>

            <!-- Chart Container -->
            <div id="energyChart" class="relative w-full" style="height: 350px;"></div>

            <!-- Loading/Error States -->
            <div id="energy-loading-state" class="text-center py-8 hidden">
                <span class="loading loading-spinner loading-lg"></span>
                <p class="mt-2 text-gray-500">Daten werden geladen...</p>
            </div>
            <div id="energy-error-state" class="alert alert-warning hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span id="energy-error-message">Keine Daten verfügbar</span>
            </div>
        </div>
    </div>

    <!-- Additional Info Card -->
    {% if inverter.rated_power or inverter.number_of_mppts %}
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="card-body p-2 md:p-6">
            <h2 class="card-title">Wechselrichter-Informationen</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% if inverter.rated_power %}
                <div>
                    <span class="text-sm text-gray-500">Nennleistung:</span>
                    <p class="text-lg font-medium">{{ inverter.rated_power }} W</p>
                </div>
                {% endif %}
                {% if inverter.number_of_mppts %}
                <div>
                    <span class="text-sm text-gray-500">Anzahl MPPTs:</span>
                    <p class="text-lg font-medium">{{ inverter.number_of_mppts }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    (function() {
        const inverterId = {{ inverter.id }};
        let currentTimeRange = '{{ time_range }}';
        let autoRefreshInterval = null;
        let chartInitialized = false;

        // Initialize Plotly chart
        function initChart() {
            const chartDiv = document.getElementById('powerChart');
            if (!chartDiv || chartInitialized) return;

            const layout = {
                title: '',
                xaxis: {
                    title: '',
                    type: 'date',
                    showgrid: false
                },
                yaxis: {
                    title: 'Leistung (W)',
                    rangemode: 'tozero',
                    ticksuffix: ' W'
                },
                hovermode: 'x unified',
                showlegend: false,
                margin: {
                    l: 60,
                    r: 30,
                    t: 30,
                    b: 50
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };

            const config = {
                responsive: true,
                displayModeBar: false,
                displaylogo: false,
            };

            const trace = {
                x: [],
                y: [],
                type: 'scatter',
                mode: 'lines',
                fill: 'tozeroy',
                line: {
                    color: 'rgb(59, 130, 246)',
                    width: 2,
                    shape: 'spline'
                },
                fillcolor: 'rgba(59, 130, 246, 0.1)',
                name: 'Leistung'
            };

            Plotly.newPlot('powerChart', [trace], layout, config);
            chartInitialized = true;
        }

    // Load dashboard data from API
    async function loadDashboardData() {
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const chartDiv = document.getElementById('powerChart');

        // Show loading state
        loadingState.classList.remove('hidden');
        errorState.classList.add('hidden');
        chartDiv.classList.add('opacity-50');

        try {
            const response = await fetch(`/api/dashboard/${inverterId}/data?time_range=${currentTimeRange}`);
            const result = await response.json();

            if (result.success && result.data.length > 0) {
                // Update chart with Plotly
                const timestamps = result.data.map(d => d.time);
                const values = result.data.map(d => d.power);

                Plotly.update('powerChart', {
                    x: [timestamps],
                    y: [values]
                }, {}, [0]);

                // Update statistics
                document.getElementById('stat-current').textContent = result.stats.current + ' W';
                document.getElementById('stat-max').textContent = result.stats.max + ' W';
                document.getElementById('stat-today-kwh').textContent = result.stats.today_kwh.toFixed(2) + ' kWh';
                document.getElementById('stat-avg-hour').textContent = result.stats.avg_last_hour + ' W';

                // Update last update time
                const now = new Date();
                document.getElementById('last-update').textContent = now.toLocaleTimeString('de-DE');

                // Hide error, show chart
                errorState.classList.add('hidden');
                chartDiv.classList.remove('opacity-50');
            } else {
                // Show error message
                document.getElementById('error-message').textContent = result.message || 'Keine Daten verfügbar';
                errorState.classList.remove('hidden');
                chartDiv.classList.add('opacity-50');
            }
        } catch (error) {
            console.error('Failed to load dashboard data:', error);
            document.getElementById('error-message').textContent = 'Fehler beim Laden der Daten';
            errorState.classList.remove('hidden');
            chartDiv.classList.add('opacity-50');
        } finally {
            loadingState.classList.add('hidden');
        }
    }

        // Change time range
        function changeTimeRange(range) {
            currentTimeRange = range;

            // Update active button
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                if (btn.dataset.range === range) {
                    btn.classList.add('btn-active');
                } else {
                    btn.classList.remove('btn-active');
                }
            });

            // Reload data
            loadDashboardData();

            // Update URL without page reload
            const url = new URL(window.location);
            url.searchParams.set('time_range', range);
            window.history.pushState({}, '', url);
        }

        // Start auto-refresh
        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing interval
            autoRefreshInterval = setInterval(() => {
                loadDashboardData();
            }, 30000); // 30 seconds
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Initialize dashboard
        function initializeDashboard() {
            chartInitialized = false;
            initChart();
            loadDashboardData();
            startAutoRefresh();
        }

        // Expose changeTimeRange to global scope for onclick handlers
        window.changeTimeRange = changeTimeRange;
        window.loadDashboardData = loadDashboardData;

        // Initialize on page load (direct navigation)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            // DOM already loaded (HTMX swap)
            initializeDashboard();
        }

        // Re-initialize when content is swapped by HTMX
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.querySelector('#powerChart')) {
                chartInitialized = false;
                stopAutoRefresh();
                initializeDashboard();
            }
        });

        // Stop auto-refresh when navigating away
        window.addEventListener('beforeunload', stopAutoRefresh);

        // Stop auto-refresh on HTMX navigation
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            // Only stop if we're navigating away from dashboard
            if (!evt.detail.path || !evt.detail.path.includes('/dashboard/')) {
                stopAutoRefresh();
            }
        });
    })();

    // Energy Production Chart
    (function() {
        const inverterId = {{ inverter.id }};
        let currentEnergyPeriod = 'day';
        let energyChartInitialized = false;

        // Initialize energy chart
        function initEnergyChart() {
            const chartDiv = document.getElementById('energyChart');
            if (!chartDiv || energyChartInitialized) return;

            const layout = {
                title: '',
                xaxis: {
                    title: '',
                    showgrid: false,
                    tickangle: -45
                },
                yaxis: {
                    title: {
                        text: 'Energie (kWh)',
                        standoff: 15
                    },
                    rangemode: 'tozero',
                    ticksuffix: ' kWh'
                },
                hovermode: 'closest',
                showlegend: false,
                margin: {
                    l: 100,
                    r: 30,
                    t: 30,
                    b: 80
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };

            const config = {
                responsive: true,
                displayModeBar: false,
                displaylogo: false
            };

            const trace = {
                x: [],
                y: [],
                type: 'bar',
                marker: {
                    color: 'rgb(234, 179, 8)',
                    line: {
                        color: 'rgb(202, 138, 4)',
                        width: 1
                    }
                },
                hovertemplate: '<b>%{x}</b><br>%{y:.2f} kWh<extra></extra>'
            };

            Plotly.newPlot('energyChart', [trace], layout, config);
            energyChartInitialized = true;
        }

        // Load energy data from API
        async function loadEnergyData() {
            const loadingState = document.getElementById('energy-loading-state');
            const errorState = document.getElementById('energy-error-state');
            const chartDiv = document.getElementById('energyChart');

            // Show loading state
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            chartDiv.classList.add('opacity-50');

            try {
                const response = await fetch(`/api/dashboard/${inverterId}/energy-data?period=${currentEnergyPeriod}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    // Update chart with Plotly
                    const labels = result.data.map(d => d.label);
                    const values = result.data.map(d => d.energy_kwh);

                    Plotly.update('energyChart', {
                        x: [labels],
                        y: [values]
                    }, {}, [0]);

                    // Hide error, show chart
                    errorState.classList.add('hidden');
                    chartDiv.classList.remove('opacity-50');
                } else {
                    // Show error message
                    document.getElementById('energy-error-message').textContent = result.message || 'Keine Daten verfügbar';
                    errorState.classList.remove('hidden');
                    chartDiv.classList.add('opacity-50');
                }
            } catch (error) {
                console.error('Failed to load energy data:', error);
                document.getElementById('energy-error-message').textContent = 'Fehler beim Laden der Daten';
                errorState.classList.remove('hidden');
                chartDiv.classList.add('opacity-50');
            } finally {
                loadingState.classList.add('hidden');
            }
        }

        // Change energy period
        function changeEnergyPeriod(period) {
            currentEnergyPeriod = period;

            // Update active button
            document.querySelectorAll('.energy-period-tab').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.add('btn-active');
                } else {
                    btn.classList.remove('btn-active');
                }
            });

            // Update description
            const descriptions = {
                day: 'Stündliche Energieproduktion für heute',
                week: 'Tägliche Energieproduktion dieser Woche',
                month: 'Tägliche Energieproduktion dieses Monats'
            };
            document.getElementById('energy-period-description').textContent = descriptions[period];

            // Reload data
            loadEnergyData();
        }

        // Handle responsive chart height
        function updateEnergyChartHeight() {
            const chartDiv = document.getElementById('energyChart');
            const isMobile = window.innerWidth < 768;
            chartDiv.style.height = isMobile ? '350px' : '500px';
            if (energyChartInitialized) {
                Plotly.Plots.resize('energyChart');
            }
        }

        // Initialize energy chart
        function initializeEnergyChart() {
            energyChartInitialized = false;
            initEnergyChart();
            loadEnergyData();
            updateEnergyChartHeight();
        }

        // Expose changeEnergyPeriod to global scope for onclick handlers
        window.changeEnergyPeriod = changeEnergyPeriod;

        // Initialize on page load (direct navigation)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeEnergyChart);
        } else {
            // DOM already loaded (HTMX swap)
            initializeEnergyChart();
        }

        // Re-initialize when content is swapped by HTMX
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.querySelector('#energyChart')) {
                energyChartInitialized = false;
                initializeEnergyChart();
            }
        });

        // Handle window resize
        window.addEventListener('resize', updateEnergyChartHeight);
    })();
</script>

{% endblock %}
