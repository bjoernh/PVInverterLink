services:
    # NOTE: Traefik is already running separately from traefik_runing/
    # This compose file connects services to the existing traefik-public network

    # Backend Service (Test)
    backend-test:
        image: ghcr.io/bjoernh/pvinverterlink:${IMAGE_TAG:-test}
        container_name: backend-test
        pull_policy: always
        restart: unless-stopped
        #ports:
        #    - 8080:80

        env_file:
            - .env
        environment:
            - ENV_FILE=.env
            - DATABASE_URL=postgresql+asyncpg://deyehard:${POSTGRES_PASSWORD}@db-test:5432/deyehard
            # POSTGRES_PASSWORD from .env.test
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://signoz-otel-collector:4317
            - OTEL_RESOURCE_ATTRIBUTES=service.name=solar-backend-test
            - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
        networks:
            - traefik-public
            - signoz-net
        volumes:
            - .env:/app/.env:ro
        depends_on:
            db-test:
                condition: service_healthy
            # OTEL collector removed for now - focus on backend + db first
            # signoz-otel-collector-test:
            #   condition: service_started
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:80/healthcheck"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 20s
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.backend-test.rule=Host(`test.solar.64b.de`)"
            - "traefik.http.routers.backend-test.entrypoints=web,websecure"
            - "traefik.http.services.backend-test.loadbalancer.server.port=80"
            - "traefik.docker.network=traefik-public"

    # TimescaleDB (Test)
    db-test:
        image: timescale/timescaledb:latest-pg16
        container_name: db-test
        restart: unless-stopped
        env_file:
            - .env
        environment:
            - POSTGRES_USER=deyehard
            - POSTGRES_DB=deyehard
            # POSTGRES_PASSWORD from .env.test
        volumes:
            - ./data/test/postgres:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U deyehard"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - traefik-public

    # Rust Collector (Test)
    collector-test:
        image: ghcr.io/bjoernh/solarmancollector:latest
        container_name: collector-test
        restart: unless-stopped
        env_file:
            - .env
        environment:
            - PORT=10000
            - RUST_LOG=info
            - DATABASE_URL=postgresql://deyehard:${POSTGRES_PASSWORD}@db-test:5432/deyehard
            #- OTEL_EXPORTER_OTLP_ENDPOINT=http://signoz-otel-collector-test:4317
            #- OTEL_SERVICE_NAME=collector-test
        ports:
            - "10000:10000" # Exposed for Solarman loggers
        depends_on:
            db-test:
                condition: service_healthy
            backend-test:
                condition: service_started
        networks:
            - traefik-public

networks:
    traefik-public:
        external: true
    signoz-net:
        external: true
        name: signoz-net
#    test-internal:
#        name: test-internal
#volumes:
#    signoz-test-data:
#        name: signoz-test-data
