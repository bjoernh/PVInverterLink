---
kind: pipeline
type: docker
name: test

trigger:
  event:
    - pull_request
  branch:
    - main

steps:
  - name: pytest
    image: python:3.11.9-alpine@sha256:700b4aa84090748aafb348fc042b5970abb0a73c8f1b4fcfe0f4e3c2a4a9fcca
    commands:
      - export POETRY_HOME=/opt/poetry
      - python3 -m venv $POETRY_HOME
      - $POETRY_HOME/bin/pip install poetry==1.8.3
      - $POETRY_HOME/bin/poetry install
      - ENV_FILE=$DRONE_WORKSPACE/ci.env $POETRY_HOME/bin/poetry run pytest
  - name: build-dry-run
    image: plugins/docker:20.18.3@sha256:5c54e77b6c5e6f75b7bbca1bcf0cf5a4a2e90e63b45dac4b4798a3ce14c72cc9
    settings:
      repo: registry.wtf-eg.net/solar/backend
      dry_run: true

---
kind: pipeline
type: docker
name: build-main

trigger:
  event:
    - push
  branch:
    - main

steps:
  - name: pytest
    image: python:3.11.9-alpine@sha256:700b4aa84090748aafb348fc042b5970abb0a73c8f1b4fcfe0f4e3c2a4a9fcca
    commands:
      - export POETRY_HOME=/opt/poetry
      - python3 -m venv $POETRY_HOME
      - $POETRY_HOME/bin/pip install poetry==1.8.3
      - $POETRY_HOME/bin/poetry install
      - ENV_FILE=$DRONE_WORKSPACE/ci.env $POETRY_HOME/bin/poetry run pytest
  - name: build
    image: plugins/docker:20.18.3@sha256:5c54e77b6c5e6f75b7bbca1bcf0cf5a4a2e90e63b45dac4b4798a3ce14c72cc9
    settings:
      repo: registry.wtf-eg.net/solar/backend
      tags:
        - main
      registry: registry.wtf-eg.net
      username:
        from_secret: "docker_username"
      password:
        from_secret: "docker_password"

---
kind: pipeline
type: docker
name: build-tag

trigger:
  event:
    - tag

steps:
  - name: pytest
    image: python:3.11.9-alpine@sha256:700b4aa84090748aafb348fc042b5970abb0a73c8f1b4fcfe0f4e3c2a4a9fcca
    commands:
      - export POETRY_HOME=/opt/poetry
      - python3 -m venv $POETRY_HOME
      - $POETRY_HOME/bin/pip install poetry==1.8.3
      - $POETRY_HOME/bin/poetry install
      - ENV_FILE=$DRONE_WORKSPACE/ci.env $POETRY_HOME/bin/poetry run pytest
  - name: build
    image: plugins/docker:20.18.3@sha256:5c54e77b6c5e6f75b7bbca1bcf0cf5a4a2e90e63b45dac4b4798a3ce14c72cc9
    settings:
      repo: registry.wtf-eg.net/solar/backend
      auto_tag: true
      registry: registry.wtf-eg.net
      username:
        from_secret: "docker_username"
      password:
        from_secret: "docker_password"
